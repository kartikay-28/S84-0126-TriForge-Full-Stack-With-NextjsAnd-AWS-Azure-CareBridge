
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
}

enum RecordType {
  LAB_RESULTS
  PRESCRIPTION
  IMAGING
  CONSULTATION
  OTHER
}

enum AccessStatus {
  PENDING
  APPROVED
  DENIED
  REVOKED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Patient relationships
  medicalRecords    MedicalRecord[]
  grantedAccesses   AccessGrant[] @relation("PatientAccess")
  healthMetrics     HealthMetric[]
  sentMessages      Message[] @relation("PatientMessages")
  
  // Doctor relationships
  receivedAccesses  AccessGrant[] @relation("DoctorAccess")
  receivedMessages  Message[] @relation("DoctorMessages")

  @@map("users")
}

model MedicalRecord {
  id          String     @id @default(cuid())
  title       String
  description String?
  recordType  RecordType
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  patientId   String
  uploadedAt  DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  patient User @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("medical_records")
}

model AccessGrant {
  id          String       @id @default(cuid())
  patientId   String
  doctorId    String
  status      AccessStatus @default(PENDING)
  grantedAt   DateTime?
  expiresAt   DateTime?
  requestedAt DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  patient User @relation("PatientAccess", fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User @relation("DoctorAccess", fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([patientId, doctorId])
  @@map("access_grants")
}

model HealthMetric {
  id          String   @id @default(cuid())
  patientId   String
  metricType  String   // blood_pressure, heart_rate, weight, etc.
  value       String   // JSON string for complex values
  unit        String?
  recordedAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  patient User @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("health_metrics")
}

model Message {
  id         String   @id @default(cuid())
  patientId  String
  doctorId   String
  content    String
  sentBy     Role     // PATIENT or DOCTOR
  readAt     DateTime?
  sentAt     DateTime @default(now())

  patient User @relation("PatientMessages", fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User @relation("DoctorMessages", fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("messages")
}