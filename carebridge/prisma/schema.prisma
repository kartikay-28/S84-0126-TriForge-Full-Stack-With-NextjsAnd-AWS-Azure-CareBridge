
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
}

enum AccessGrantStatus {
  PENDING
  APPROVED
  DENIED
  REVOKED
}

enum RecordType {
  LAB_RESULTS
  PRESCRIPTION
  IMAGING
  CONSULTATION
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ConsultationPreference {
  IN_PERSON
  VIDEO_CALL
  PHONE_CALL
  CHAT
}

enum ConsultationMode {
  IN_PERSON_ONLY
  ONLINE_ONLY
  BOTH
}

enum MedicalCondition {
  HEART_DISEASE
  DIABETES
  HYPERTENSION
  ASTHMA
  ARTHRITIS
  DEPRESSION
  ANXIETY
  SKIN_CONDITIONS
  DIGESTIVE_ISSUES
  HEADACHES_MIGRAINES
  BACK_PAIN
  ALLERGIES
  RESPIRATORY_ISSUES
  KIDNEY_DISEASE
  LIVER_DISEASE
  THYROID_DISORDERS
  CANCER
  NEUROLOGICAL_DISORDERS
  MENTAL_HEALTH
  WOMENS_HEALTH
  MENS_HEALTH
  PEDIATRIC_CARE
  GERIATRIC_CARE
  GENERAL_CHECKUP
  PREVENTIVE_CARE
  OTHER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  password     String
  role         Role
  profileLevel Int      @default(0) // 0-3 profile completion level
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations for access grants
  grantedAccess  AccessGrant[] @relation("PatientGrants")
  receivedAccess AccessGrant[] @relation("DoctorGrants")

  // Relations for medical records
  medicalRecords MedicalRecord[]

  // Profile relations
  patientProfile PatientProfile?
  doctorProfile  DoctorProfile?

  // Assignment relations
  patientAssignments Assignment[] @relation("PatientAssignments")
  doctorAssignments  Assignment[] @relation("DoctorAssignments")

  @@map("users")
}

model PatientProfile {
  id     String @id @default(cuid())
  userId String @unique

  // LEVEL 1 (required)
  age                     Int?
  gender                  Gender?
  primaryProblem          MedicalCondition?
  symptoms                String[] // max 3
  consultationPreference  ConsultationPreference?

  // LEVEL 2 (optional)
  medicalHistory          String[]
  currentMedications      String[]
  emergencyContactName    String?
  emergencyContactPhone   String?
  emergencyContactRelationship String?
  lifestyleSmoking        String?
  lifestyleDrinking       String?
  lifestyleExercise       String?

  // LEVEL 3 (optional)
  vitalsBp                String? // blood pressure
  vitalsSugar             String? // blood sugar
  vitalsHeartRate         Int?    // heart rate
  vitalsOxygen            Int?    // oxygen level

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patient_profiles")
}

model DoctorProfile {
  id     String @id @default(cuid())
  userId String @unique

  // LEVEL 1 (required)
  specialization     String?
  experienceYears    Int?
  conditionsTreated  String[]
  consultationMode   ConsultationMode?
  availability       String? // JSON string for availability schedule

  // LEVEL 2 (optional)
  qualifications     String[]
  clinicName         String?
  clinicAddress      String?
  clinicPhone        String?
  consultationFee    Float?
  languagesSpoken    String[]

  // LEVEL 3 (optional)
  licenseDocument    String? // URL to license document
  bio                String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("doctor_profiles")
}

model Assignment {
  id         String   @id @default(cuid())
  patientId  String
  doctorId   String
  assignedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  patient User @relation("PatientAssignments", fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User @relation("DoctorAssignments", fields: [doctorId], references: [id], onDelete: Cascade)

  // Prevent duplicate assignments
  @@unique([patientId, doctorId])
  @@map("assignments")
}

model AccessGrant {
  id          String            @id @default(cuid())
  patientId   String
  doctorId    String
  status      AccessGrantStatus @default(PENDING)
  requestedAt DateTime          @default(now())
  grantedAt   DateTime?
  expiresAt   DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  patient User @relation("PatientGrants", fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User @relation("DoctorGrants", fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([patientId, doctorId], name: "patientId_doctorId")
  @@map("access_grants")
}

model MedicalRecord {
  id          String     @id @default(cuid())
  title       String
  description String?
  recordType  RecordType
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  patientId   String
  uploadedAt  DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  patient User @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("medical_records")
}